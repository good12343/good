import React, { useState, useEffect } from "react";
import { Connection, PublicKey, SystemProgram, Transaction } from "@solana/web3.js";
import { WalletMultiButton } from "@solana/wallet-adapter-react-ui";
import { useWallet } from "@solana/wallet-adapter-react";
import "./App.css";

const SOLANA_RPC = "https://api.devnet.solana.com"; // Devnet for testing
const connection = new Connection(SOLANA_RPC);

export default function Purchase() {
  const { publicKey, connected, sendTransaction } = useWallet();
    const [balance, setBalance] = useState(null);
      const [theme, setTheme] = useState("light");
        const [amount, setAmount] = useState("");
          const [frep, setFrep] = useState(0);

            // toggle light/dark mode
              const toggleTheme = () => {
                  setTheme(theme === "light" ? "dark" : "light");
                      document.documentElement.classList.toggle("dark");
                        };

                          // fetch solana balance
                            useEffect(() => {
                                if (connected && publicKey) {
                                      connection.getBalance(publicKey).then((lamports) => {
                                              setBalance(lamports / 1e9);
                                                    });
                                                        }
                                                          }, [connected, publicKey]);

                                                            // calculate FREP
                                                              useEffect(() => {
                                                                  if (amount) {
                                                                        setFrep(amount / 0.001);
                                                                            } else {
                                                                                  setFrep(0);
                                                                                      }
                                                                                        }, [amount]);

                                                                                          // handle buy transaction (test transfer on Devnet)
                                                                                            const handleBuy = async () => {
                                                                                                if (!publicKey) return;

                                                                                                    try {
                                                                                                          // حط عنوانك انت هنا (مالك المشروع)
                                                                                                                const recipient = new PublicKey("G14KXQj3V5gcPgVMS4MQHaGYxuPhCVfVtf7wHJ7yYx7q");

                                                                                                                      const tx = new Transaction().add(
                                                                                                                              SystemProgram.transfer({
                                                                                                                                        fromPubkey: publicKey,
                                                                                                                                                  toPubkey: recipient,
                                                                                                                                                            lamports: 0.001 * 1e9, // 0.001 SOL for test
                                                                                                                                                                    })
                                                                                                                                                                          );

                                                                                                                                                                                const signature = await sendTransaction(tx, connection);
                                                                                                                                                                                      await connection.confirmTransaction(signature, "confirmed");
                                                                                                                                                                                            alert(`✅ Transaction sent! Signature: ${signature}`);
                                                                                                                                                                                                } catch (err) {
                                                                                                                                                                                                      console.error(err);
                                                                                                                                                                                                            alert("❌ Transaction failed!");
                                                                                                                                                                                                                }
                                                                                                                                                                                                                  };

                                                                                                                                                                                                                    return (
                                                                                                                                                                                                                        <div
                                                                                                                                                                                                                              className={`min-h-screen flex flex-col items-center justify-center p-6 transition ${
                                                                                                                                                                                                                                      theme === "dark" ? "bg-gray-900 text-white" : "bg-gray-50 text-gray-900"
                                                                                                                                                                                                                                            }`}
                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                      {/* Header */}
                                                                                                                                                                                                                                                            <div className="flex w-full justify-between items-center max-w-4xl mb-8">
                                                                                                                                                                                                                                                                    <h1 className="text-2xl font-bold">FREP Launchpad</h1>
                                                                                                                                                                                                                                                                            <div className="flex items-center gap-4">
                                                                                                                                                                                                                                                                                      <button
                                                                                                                                                                                                                                                                                                  onClick={toggleTheme}
                                                                                                                                                                                                                                                                                                              className="p-2 rounded-full bg-gray-200 dark:bg-gray-700"
                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                    {theme === "light" ? <Moon size={20} /> : <Sun size={20} />}
                                                                                                                                                                                                                                                                                                                                              </button>
                                                                                                                                                                                                                                                                                                                                                        <WalletMultiButton />
                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                            {/* Wallet Info */}
                                                                                                                                                                                                                                                                                                                                                                                  {connected && publicKey && (
                                                                                                                                                                                                                                                                                                                                                                                          <div className="mb-6 text-center">
                                                                                                                                                                                                                                                                                                                                                                                                    <p className="text-sm">
                                                                                                                                                                                                                                                                                                                                                                                                                Connected Wallet:{" "}
                                                                                                                                                                                                                                                                                                                                                                                                                            <span className="font-mono">
                                                                                                                                                                                                                                                                                                                                                                                                                                          {publicKey.toBase58().slice(0, 6)}...
                                                                                                                                                                                                                                                                                                                                                                                                                                                        {publicKey.toBase58().slice(-4)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p className="text-sm">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Balance:{" "}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span className="font-semibold">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {balance !== null ? `${balance.toFixed(3)} SOL` : "..."}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* Calculator */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div className="bg-white dark:bg-gray-800 shadow-xl rounded-2xl p-6 w-full max-w-md">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <h2 className="text-xl font-bold mb-4">Token Calculator</h2>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div className="flex items-center gap-2 mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    type="number"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                value={amount}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onChange={(e) => setAmount(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        placeholder="Enter USD amount"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="flex-1 px-4 py-2 rounded-lg border dark:bg-gray-900 dark:border-gray-600"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span className="font-medium">USD</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p className="mb-2">$0.001 = 1 FREP</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p className="font-bold">You Get: {frep.toFixed(2)} FREP</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Buy Button */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="mt-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    disabled={!connected}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={handleBuy}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className={`px-6 py-3 rounded-2xl font-bold transition ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    connected
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ? "bg-indigo-600 text-white hover:bg-indigo-700"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : "bg-gray-400 text-gray-200 cursor-not-allowed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Buy Now
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }