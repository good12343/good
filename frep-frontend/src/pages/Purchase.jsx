import React, { useState, useEffect } from "react";
import { Connection, PublicKey, Transaction, SystemProgram } from "@solana/web3.js";
import { WalletMultiButton } from "@solana/wallet-adapter-react-ui";
import { useWallet } from "@solana/wallet-adapter-react";
import "../App.css";

const SOLANA_RPC = "https://api.mainnet-beta.solana.com";
const connection = new Connection(SOLANA_RPC);

const currencyRates = {
  USDT: 1,
    USDC: 1,
      SOL: 25,
      };

      export default function Purchase() {
        const { publicKey, connected, sendTransaction } = useWallet();

          const [balance, setBalance] = useState(null);
            const [amount, setAmount] = useState("");
              const [frep, setFrep] = useState(0);
                const [currency, setCurrency] = useState("USDT");

                  const priceFrep = 0.001;

                    useEffect(() => {
                        if (connected && publicKey) {
                              connection.getBalance(publicKey).then((lamports) => setBalance(lamports / 1e9));
                                  }
                                    }, [connected, publicKey]);

                                      useEffect(() => {
                                          const calcFrep = () => {
                                                if (amount) {
                                                        const rate = currencyRates[currency] || 1;
                                                                setFrep((amount * rate) / priceFrep);
                                                                      } else setFrep(0);
                                                                          };
                                                                              calcFrep();
                                                                                  const interval = setInterval(calcFrep, 15000);
                                                                                      return () => clearInterval(interval);
                                                                                        }, [amount, currency]);

                                                                                          const handleBuy = async () => {
                                                                                              if (!connected || !publicKey || !amount || amount <= 0) return;

                                                                                                  try {
                                                                                                        const lamports = currency === "SOL" ? amount * 1e9 : 0;
                                                                                                              const transaction = new Transaction().add(
                                                                                                                      SystemProgram.transfer({
                                                                                                                                fromPubkey: publicKey,
                                                                                                                                          toPubkey: new PublicKey("DESTINATION_WALLET_ADDRESS"),
                                                                                                                                                    lamports,
                                                                                                                                                            })
                                                                                                                                                                  );
                                                                                                                                                                        const signature = await sendTransaction(transaction, connection);
                                                                                                                                                                              await connection.confirmTransaction(signature, "confirmed");
                                                                                                                                                                                    alert("تم شراء FREP بنجاح!");
                                                                                                                                                                                        } catch (error) {
                                                                                                                                                                                              console.error(error);
                                                                                                                                                                                                    alert("فشل الشراء: " + error.message);
                                                                                                                                                                                                        }
                                                                                                                                                                                                          };

                                                                                                                                                                                                            return (
                                                                                                                                                                                                                <div className="min-h-screen flex flex-col items-center bg-gradient-to-b from-gray-900 to-gray-800 text-white px-4 py-10">

                                                                                                                                                                                                                      {/* Header */}
                                                                                                                                                                                                                            <header className="w-full max-w-5xl flex flex-col sm:flex-row justify-between items-center mb-12 gap-6">
                                                                                                                                                                                                                                    <h1 className="text-4xl sm:text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 text-center sm:text-left">
                                                                                                                                                                                                                                              FREP Launchpad
                                                                                                                                                                                                                                                      </h1>
                                                                                                                                                                                                                                                              <WalletMultiButton className="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-xl shadow-lg transition-all duration-300" />
                                                                                                                                                                                                                                                                    </header>

                                                                                                                                                                                                                                                                          {/* Wallet Info */}
                                                                                                                                                                                                                                                                                {connected && publicKey && (
                                                                                                                                                                                                                                                                                        <div className="w-full max-w-md p-6 mb-10 bg-gray-800 rounded-2xl shadow-xl flex flex-col items-center gap-3">
                                                                                                                                                                                                                                                                                                  <p className="text-sm">
                                                                                                                                                                                                                                                                                                              Connected Wallet:{" "}
                                                                                                                                                                                                                                                                                                                          <span className="font-mono text-purple-400">{publicKey.toBase58().slice(0, 6)}...{publicKey.toBase58().slice(-4)}</span>
                                                                                                                                                                                                                                                                                                                                    </p>
                                                                                                                                                                                                                                                                                                                                              <p className="text-sm">
                                                                                                                                                                                                                                                                                                                                                          Balance: <span className="font-semibold text-green-400">{balance !== null ? `${balance.toFixed(3)} SOL` : "..."}</span>
                                                                                                                                                                                                                                                                                                                                                                    </p>
                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                  )}

                                                                                                                                                                                                                                                                                                                                                                                        {/* Purchase Card */}
                                                                                                                                                                                                                                                                                                                                                                                              <div className="w-full max-w-md p-8 bg-gray-900 rounded-3xl shadow-2xl flex flex-col items-center gap-6">
                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                              {/* Cryptocurrency Icons */}
                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="flex justify-center gap-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                <img src="/icons/usdt.png" alt="USDT" className="w-12 h-12 hover:scale-110 transition-transform" />
                                                                                                                                                                                                                                                                                                                                                                                                                                          <img src="/icons/usdc.png" alt="USDC" className="w-12 h-12 hover:scale-110 transition-transform" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <img src="/icons/sol.png" alt="SOL" className="w-12 h-12 hover:scale-110 transition-transform" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {/* Price Info */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p className="text-center font-medium text-lg text-gray-300">(1 FREP = 0.001$)</p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {/* Currency Selector */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="flex justify-center gap-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {["USDT", "USDC", "SOL"].map((c) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                key={c}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={() => setCurrency(c)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            className={`px-5 py-2 rounded-xl font-semibold transition-colors ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            currency === c
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ? "bg-purple-600 text-white shadow-lg"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : "bg-gray-700 hover:bg-gray-600 text-gray-200"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {c}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {/* Amount Input */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                type="number"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          placeholder={`Amount in ${currency}`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    value={amount}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onChange={(e) => setAmount(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="w-full px-5 py-3 rounded-xl bg-gray-800 border border-gray-700 text-white shadow-inner focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* FREP Display */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p className="w-full text-center font-bold text-2xl py-3 rounded-xl bg-gray-700 shadow-inner">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          FREP: {frep.toFixed(3)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {/* Buy Button */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onClick={handleBuy}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      disabled={!connected || !amount || amount <= 0}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                className={`w-full py-3 rounded-xl font-bold text-lg transition-all ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            !connected || !amount || amount <= 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ? "bg-gray-600 cursor-not-allowed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        : "bg-purple-600 hover:bg-purple-700 shadow-lg transform hover:scale-105"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    شراء الآن
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }