import React, { useState, useEffect } from "react";
import { Connection, PublicKey, Transaction, SystemProgram } from "@solana/web3.js";
import { WalletMultiButton } from "@solana/wallet-adapter-react-ui";
import { useWallet } from "@solana/wallet-adapter-react";
import "../App.css";

const SOLANA_RPC = "https://api.mainnet-beta.solana.com";
const connection = new Connection(SOLANA_RPC);

// أسعار تقريبية، يمكن تعديلها لجلب الأسعار من API
const currencyRates = {
  USDT: 1,
    USDC: 1,
      SOL: 25, // مثال: 1 SOL = 25$
      };

      export default function Purchase() {
        const { publicKey, connected, sendTransaction } = useWallet();

          const [balance, setBalance] = useState(null);
            const [amount, setAmount] = useState("");
              const [frep, setFrep] = useState(0);
                const [currency, setCurrency] = useState("USDT");

                  const priceFrep = 0.001; // 1FREP = 0.001$

                    // تحديث رصيد المحفظة
                      useEffect(() => {
                          if (connected && publicKey) {
                                connection.getBalance(publicKey).then((lamports) => {
                                        setBalance(lamports / 1e9);
                                              });
                                                  }
                                                    }, [connected, publicKey]);

                                                      // تحديث الحاسبة كل 15 ثانية
                                                        useEffect(() => {
                                                            const calcFrep = () => {
                                                                  if (amount) {
                                                                          const rate = currencyRates[currency] || 1;
                                                                                  setFrep((amount * rate) / priceFrep);
                                                                                        } else {
                                                                                                setFrep(0);
                                                                                                      }
                                                                                                          };
                                                                                                              calcFrep();
                                                                                                                  const interval = setInterval(calcFrep, 15000);
                                                                                                                      return () => clearInterval(interval);
                                                                                                                        }, [amount, currency]);

                                                                                                                          // التعامل مع شراء FREP
                                                                                                                            const handleBuy = async () => {
                                                                                                                                if (!connected || !publicKey || !amount || amount <= 0) return;

                                                                                                                                    try {
                                                                                                                                          // مثال: تحويل SOL فقط (يمكن تعديل المعاملة حسب العملة)
                                                                                                                                                const lamports = currency === "SOL" ? amount * 1e9 : 0;
                                                                                                                                                      const transaction = new Transaction().add(
                                                                                                                                                              SystemProgram.transfer({
                                                                                                                                                                        fromPubkey: publicKey,
                                                                                                                                                                                  toPubkey: new PublicKey("DESTINATION_WALLET_ADDRESS"),
                                                                                                                                                                                            lamports,
                                                                                                                                                                                                    })
                                                                                                                                                                                                          );

                                                                                                                                                                                                                const signature = await sendTransaction(transaction, connection);
                                                                                                                                                                                                                      await connection.confirmTransaction(signature, "confirmed");
                                                                                                                                                                                                                            alert("تم شراء FREP بنجاح!");
                                                                                                                                                                                                                                } catch (error) {
                                                                                                                                                                                                                                      console.error(error);
                                                                                                                                                                                                                                            alert("فشل الشراء: " + error.message);
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                  };

                                                                                                                                                                                                                                                    return (
                                                                                                                                                                                                                                                        <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white">
                                                                                                                                                                                                                                                              {/* Header */}
                                                                                                                                                                                                                                                                    <div className="flex w-full justify-between items-center max-w-4xl mb-8">
                                                                                                                                                                                                                                                                            <h1 className="text-2xl font-bold">FREP Launchpad</h1>
                                                                                                                                                                                                                                                                                    <WalletMultiButton className="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition" />
                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                                {/* Wallet Info */}
                                                                                                                                                                                                                                                                                                      {connected && publicKey && (
                                                                                                                                                                                                                                                                                                              <div className="mb-6 text-center">
                                                                                                                                                                                                                                                                                                                        <p className="text-sm">
                                                                                                                                                                                                                                                                                                                                    Connected Wallet:{" "}
                                                                                                                                                                                                                                                                                                                                                <span className="font-mono">
                                                                                                                                                                                                                                                                                                                                                              {publicKey.toBase58().slice(0, 6)}...{publicKey.toBase58().slice(-4)}
                                                                                                                                                                                                                                                                                                                                                                          </span>
                                                                                                                                                                                                                                                                                                                                                                                    </p>
                                                                                                                                                                                                                                                                                                                                                                                              <p className="text-sm">
                                                                                                                                                                                                                                                                                                                                                                                                          Balance:{" "}
                                                                                                                                                                                                                                                                                                                                                                                                                      <span className="font-semibold">{balance !== null ? `${balance.toFixed(3)} SOL` : "..."}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                              )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                    {/* الحاسبة */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="max-w-md w-full p-6 mb-6 border rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 shadow">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {/* أيقونات العملات */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="flex justify-center gap-4 mb-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <img src="/icons/usdt.png" alt="USDT" className="w-6 h-6" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <img src="/icons/usdc.png" alt="USDC" className="w-6 h-6" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <img src="/icons/sol.png" alt="SOL" className="w-6 h-6" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* سعر FREP */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p className="text-center mb-4 font-medium">(1FREP = 0.001$)</p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* اختيار العملة */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="flex justify-center gap-2 mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {["USDT", "USDC", "SOL"].map((c) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    key={c}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onClick={() => setCurrency(c)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                className={`px-3 py-1 rounded-lg ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                currency === c ? "bg-blue-600 text-white" : "bg-gray-200 dark:bg-gray-700"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {c}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {/* إدخال المبلغ */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                type="number"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          placeholder={`Amount in ${currency}`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    value={amount}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onChange={(e) => setAmount(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="w-full px-4 py-2 rounded-lg border mb-4 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                />

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* عرض FREP المحسوب */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p className="text-center font-semibold mb-4">FREP: {frep.toFixed(3)}</p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* زر الشراء */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          onClick={handleBuy}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    disabled={!connected || !amount || amount <= 0}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className={`w-full py-2 rounded-lg text-white ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          !connected || !amount || amount <= 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ? "bg-gray-400 cursor-not-allowed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      : "bg-green-600 hover:bg-green-700"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  شراء الآن
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }